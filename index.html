<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>にゃんこ大戦争スケジュール</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <header>
      にゃんこ大戦争スケジュール
      <a class="tsv-link" href="https://script.google.com/macros/s/AKfycbwnbI6ppe7d9CNwdpU9QugQq99UAFWFKw2KL9YdnK2pWOyZNIvoZNCo34OMdqhEcJaW/exec" target="_blank">tsvリンク</a>
      <button id="save-btn">画像として保存</button>
    </header>

    <div class="tabs">
      <div class="tab active" onclick="showTab('gatya4')">gatya</div>
      <div class="tab" onclick="showTab('sale4')">sale</div>
      <div class="tab" onclick="showTab('item3')">item</div>
      <div class="tab" onclick="showTab('mission')">mission</div>
      <div class="tab" onclick="showTab('all')">すべての予定</div>
    </div>

    <div class="checkbox-container">
      <input type="checkbox" id="showAll" />
      <label for="showAll">開催中のイベントも表示</label>
    </div>

    <main id="main-container">
      <div id="gatya4" class="content"></div>
      <div id="sale4" class="content hidden"></div>
      <div id="item3" class="content hidden"></div>
      <div id="mission" class="content hidden"></div>
      <div id="all" class="content hidden"></div>
    </main>

    <!-- モーダル -->
    <div id="detail-modal" class="modal-backdrop">
      <div class="modal-content">
        <span id="modal-close">&times;</span>
        <div id="modal-body"></div>
      </div>
    </div>

    <script>
      let data = {};
      const now = new Date();

      fetch('https://Shibanban2.github.io/bc-event/data.json')
        .then(res => res.json())
        .then(json => {
          data = json;
          renderContent('gatya4', false);
        });

      function parseStartDate(text) {
        const match = text.match(/^(\d{2})\/(\d{2})/);
        if (!match) return null;
        const year = new Date().getFullYear();
        const month = parseInt(match[1]) - 1;
        const day = parseInt(match[2]);
        return new Date(year, month, day);
      }

      function renderContent(id, showPast) {
                  // item3 から「ガチャ半額リセット（1回/11連）」を gatya4 へ移動
  if (data.item3) {
    const moved = data.item3.filter(text =>
      /ガチャ半額リセット（1回）/.test(text) || /ガチャ半額リセット（11連）/.test(text)
    );
    if (moved.length > 0) {
      data.item3 = data.item3.filter(text =>
        !(/ガチャ半額リセット（1回）/.test(text) || /ガチャ半額リセット（11連）/.test(text))
      );
      data.gatya4 = [...(data.gatya4 || []), ...moved];
    }
  }
        const container = document.getElementById(id);
        container.innerHTML = '';
        const sections = id === 'all' ? Object.keys(data).filter(k => k !== 'gatya5') : [id];

        for (const key of sections) {
          const title = document.createElement('div');
          title.className = 'section-title';
          title.textContent = key;
          container.appendChild(title);

          let count = 0;
          for (let i = 0; i < data[key].length; i++) {
            const text = data[key][i];
            if (key === 'gatya4' && (/プラチナガチャ|レジェンドガチャ/.test(text))) continue;
              // item3: 道場報酬 / 報酬設定（地底迷宮） を非表示
  if (key === 'item3' && (/道場報酬|報酬設定（地底迷宮）/.test(text))) continue;

            const startDate = parseStartDate(text);
            if (!showPast && startDate && startDate < now) continue;
            if (!showPast && !startDate) continue;

            const div = document.createElement('div');
            div.className = 'event-card';
 if (!/ミッション/.test(text)) {
              if (/祭|確定|レジェンドクエスト|風雲にゃんこ塔|異界にゃんこ塔|グランドアビス|闇目|ねこの目洞窟|ガチャ半額リセット|確率2倍|にゃんこスロット|必要/.test(text)) {
                div.classList.add('red');
              } else if (/おまけアップ|異次元コロシアム|強襲|ランキングの間|ネコ基地トーク/.test(text)) {
                div.classList.add('blue');
              }
            }
           

            div.innerHTML = text;

            if (key === 'gatya4') {
              div.addEventListener('click', () => {
                const detail = data.gatya5[i] || '詳細情報がありません';
                openModal(detail);
              });
            }

            container.appendChild(div);
            count++;
          }

          if (count === 0) {
            const none = document.createElement('div');
            none.textContent = '表示できるイベントはありません';
            container.appendChild(none);
          }
        }
      }

      function showTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));

        document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
        document.getElementById(id).classList.remove('hidden');

        renderContent(id, document.getElementById('showAll').checked);
      }

      document.getElementById('showAll').addEventListener('change', () => {
        const activeTab = document.querySelector('.tab.active').textContent.trim();
        const id = activeTab === 'すべての予定' ? 'all' : activeTab;
        renderContent(id, document.getElementById('showAll').checked);
      });

      function openModal(content) {
        document.getElementById('modal-body').innerHTML = content;
        document.getElementById('detail-modal').classList.add('show');
      }

      function closeModal() {
        document.getElementById('detail-modal').classList.remove('show');
      }

      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('detail-modal').addEventListener('click', e => {
        if (e.target.id === 'detail-modal') closeModal();
      });

      document.getElementById('save-btn').addEventListener('click', () => {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const fileName = `nyanko_schedule_${yyyy}-${mm}-${dd}.png`;

        html2canvas(document.body, {
          backgroundColor: '#ffffff',
          useCORS: true
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = fileName;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      });
    </script>
  </body>
</html>
