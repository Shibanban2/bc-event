<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Challenger スケジュール</title>
<style>
/* CSSは変更なし */
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; color:#333; }
header { background:#ff5555; color:#fff; text-align:center; padding:12px 0; font-size:1.5em; font-weight:bold; }
section { margin:16px; }
h2 { font-size:1.2em; margin-bottom:8px; }
.event-list { list-style:none; padding:0; margin:0; }
.event-item { background:#fff; margin-bottom:8px; padding:12px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; font-size:1em; }
.event-item.upcoming { border-left:5px solid #ff5555; }
.event-time { font-weight:bold; margin-right:8px; }
.check { transform:scale(1.2); cursor:pointer; }
button { margin:4px 0; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; background:#ff5555; color:#fff; }
#cleared-list { display:none; margin-top:8px; }
@media(max-width:600px){ .event-item { font-size:0.9em; padding:10px; } .event-time { margin-right:6px; } }
</style>
</head>
<body>

<header>New Challenger スケジュール</header>

<section>
  <button id="update-url">チェック反映URL更新</button>
  <button id="copy-url">URLをコピー</button>
  <button id="show-cleared">クリア済みを見る</button>
  <div id="cleared-list"></div>
</section>

<section>
  <h2>今日のイベント</h2>
  <ul id="today" class="event-list"></ul>
</section>

<section>
  <h2>明日のイベント</h2>
  <ul id="tomorrow" class="event-list"></ul>
</section>

<section>
  <h2>明後日以降</h2>
  <div id="future"></div>
</section>

<script>
const events = [
  // イベントデータは変更なし
  {name: "VSリュウ 初級", times:["2025-10-05T12:00","2025-10-06T03:00","2025-10-11T18:00","2025-10-13T12:00","2025-10-17T00:00","2025-10-19T12:00","2025-10-20T03:00"]},
  {name: "VSリュウ 激ムズ", times:["2025-10-04T18:00","2025-10-06T12:00","2025-10-10T12:00","2025-10-12T00:00","2025-10-13T21:00","2025-10-18T18:00"]},
  {name: "VS春麗 初級", times:["2025-10-05T12:00","2025-10-07T12:00","2025-10-11T18:00","2025-10-14T21:00","2025-10-17T00:00","2025-10-19T12:00"]},
  {name: "VS春麗 激ムズ", times:["2025-10-04T18:00","2025-10-07T03:00","2025-10-10T12:00","2025-10-12T00:00","2025-10-14T06:00","2025-10-18T18:00"]},
  {name: "VSガイル 初級", times:["2025-10-05T18:00","2025-10-08T03:00","2025-10-11T12:00","2025-10-15T12:00","2025-10-17T06:00","2025-10-19T18:00"]},
  {name: "VSガイル 激ムズ", times:["2025-10-04T12:00","2025-10-08T12:00","2025-10-10T18:00","2025-10-12T06:00","2025-10-15T03:00","2025-10-18T12:00"]},
  {name: "VSザンギエフ 初級", times:["2025-10-05T18:00","2025-10-09T12:00","2025-10-11T12:00","2025-10-16T21:00","2025-10-17T06:00","2025-10-19T18:00"]},
  {name: "VSザンギエフ 激ムズ", times:["2025-10-04T12:00","2025-10-09T03:00","2025-10-10T18:00","2025-10-12T06:00","2025-10-16T06:00","2025-10-18T12:00"]},
  {name: "VSブランカ 初級", times:["2025-10-03T12:00","2025-10-05T00:00","2025-10-06T15:00","2025-10-11T06:00","2025-10-13T00:00","2025-10-17T12:00","2025-10-19T00:00"]},
  {name: "VSブランカ 激ムズ", times:["2025-10-04T06:00","2025-10-06T06:00","2025-10-10T00:00","2025-10-12T12:00","2025-10-13T09:00","2025-10-18T06:00","2025-10-20T06:00"]},
  {name: "VSダルシム 初級", times:["2025-10-03T12:00","2025-10-05T00:00","2025-10-07T00:00","2025-10-11T06:00","2025-10-14T15:00","2025-10-17T12:00","2025-10-19T00:00"]},
  {name: "VSダルシム 激ムズ", times:["2025-10-04T06:00","2025-10-07T15:00","2025-10-10T00:00","2025-10-12T12:00","2025-10-14T00:00","2025-10-18T06:00"]},
  {name: "VSケン 初級", times:["2025-10-03T18:00","2025-10-05T06:00","2025-10-08T09:00","2025-10-11T00:00","2025-10-15T00:00","2025-10-17T18:00","2025-10-19T06:00"]},
  {name: "VSケン 激ムズ", times:["2025-10-04T00:00","2025-10-08T18:00","2025-10-10T06:00","2025-10-12T18:00","2025-10-15T21:00","2025-10-18T00:00"]},
  {name: "VSエドモンド本田 初級", times:["2025-10-03T18:00","2025-10-05T06:00","2025-10-09T00:00","2025-10-11T00:00","2025-10-16T15:00","2025-10-17T18:00","2025-10-19T06:00"]},
  {name: "VSエドモンド本田 激ムズ", times:["2025-10-04T00:00","2025-10-09T15:00","2025-10-10T06:00","2025-10-12T18:00","2025-10-16T00:00","2025-10-18T00:00"]},
  {name: "VSバイソン 中級", times:["2025-10-04T21:00","2025-10-06T09:00","2025-10-10T03:00","2025-10-12T15:00","2025-10-13T18:00","2025-10-18T21:00"]},
  {name: "VSバイソン 超激ムズ", times:["2025-10-05T15:00","2025-10-06T18:00","2025-10-11T21:00","2025-10-13T03:00","2025-10-17T03:00","2025-10-19T15:00","2025-10-20T00:00"]},
  {name: "VSバルログ 中級", times:["2025-10-04T21:00","2025-10-07T18:00","2025-10-10T03:00","2025-10-12T15:00","2025-10-14T03:00","2025-10-18T21:00"]},
  {name: "VSバルログ 超激ムズ", times:["2025-10-05T15:00","2025-10-07T09:00","2025-10-11T21:00","2025-10-14T12:00","2025-10-17T03:00","2025-10-19T15:00"]},
  {name: "VSサガット 中級", times:["2025-10-04T15:00","2025-10-08T21:00","2025-10-10T09:00","2025-10-12T21:00","2025-10-15T06:00","2025-10-18T15:00"]},
  {name: "VSサガット 超激ムズ", times:["2025-10-05T21:00","2025-10-08T06:00","2025-10-11T15:00","2025-10-15T15:00","2025-10-17T09:00","2025-10-19T21:00"]},
  {name: "VSベガ 中級", times:["2025-10-04T15:00","2025-10-09T06:00","2025-10-10T09:00","2025-10-12T21:00","2025-10-16T03:00","2025-10-18T15:00"]},
  {name: "VSベガ 超激ムズ", times:["2025-10-05T21:00","2025-10-09T21:00","2025-10-11T15:00","2025-10-16T12:00","2025-10-17T09:00","2025-10-19T21:00"]},
  {name: "VSさくら 初級", times:["2025-10-04T09:00","2025-10-08T15:00","2025-10-10T15:00","2025-10-12T03:00","2025-10-15T18:00","2025-10-18T09:00"]},
  {name: "VSさくら 激ムズ", times:["2025-10-03T15:00","2025-10-05T03:00","2025-10-08T00:00","2025-10-11T09:00","2025-10-15T09:00","2025-10-17T15:00","2025-10-19T03:00"]},
  {name: "VSルーク 初級", times:["2025-10-04T09:00","2025-10-09T18:00","2025-10-10T15:00","2025-10-12T03:00","2025-10-16T09:00","2025-10-18T09:00"]},
  {name: "VSルーク 激ムズ", times:["2025-10-03T15:00","2025-10-05T03:00","2025-10-09T09:00","2025-10-11T09:00","2025-10-16T18:00","2025-10-17T15:00","2025-10-19T03:00"]},
  {name: "VSキャミィ 初級", times:["2025-10-04T03:00","2025-10-06T21:00","2025-10-10T21:00","2025-10-12T09:00","2025-10-13T06:00","2025-10-18T03:00","2025-10-20T09:00"]},
  {name: "VSキャミィ 激ムズ", times:["2025-10-03T21:00","2025-10-05T09:00","2025-10-06T00:00","2025-10-11T03:00","2025-10-13T15:00","2025-10-17T21:00","2025-10-19T09:00"]},
  {name: "VSジュリ 初級", times:["2025-10-04T03:00","2025-10-07T06:00","2025-10-10T21:00","2025-10-12T09:00","2025-10-14T09:00","2025-10-18T03:00"]},
  {name: "VSジュリ 激ムズ", times:["2025-10-03T21:00","2025-10-05T09:00","2025-10-07T21:00","2025-10-11T03:00","2025-10-14T18:00","2025-10-17T21:00","2025-10-19T09:00"]}
];

// --- クリア済み管理（URLから） ---
let urlParams = new URLSearchParams(window.location.search);
let clearedStages = urlParams.get("cleared") ? urlParams.get("cleared").split(",") : [];

// --- DOM参照 ---
const todayEl = document.getElementById("today");
const tomorrowEl = document.getElementById("tomorrow");
const futureEl = document.getElementById("future");
const clearedEl = document.getElementById("cleared-list");

/**
 * イベント時刻文字列をJSTとして解釈したDateオブジェクトを返す
 * @param {string} timeStr - イベント時刻 ("YYYY-MM-DDTHH:MM")
 * @returns {Date} JSTとして解釈されたDateオブジェクト
 */
function getJstTime(timeStr) {
  // タイムゾーン情報がないT形式の時刻にZを付加してUTCとして解釈させる
  // ブラウザのローカルタイムゾーンの影響を受けにくくする
  return new Date(timeStr + "Z"); 
}

/**
 * JST 9:00 を基準にして、そのイベントが属する「日」を YYYY-MM-DD 形式で返す
 * @param {string} timeStr - イベント時刻 ("YYYY-MM-DDTHH:MM")
 * @returns {string} YYYY-MM-DD形式の日付文字列
 */
function getJstDate(timeStr) {
  const dt = getJstTime(timeStr);
  // JSTの時刻を取得
  const jstHours = dt.getUTCHours(); 
  const jstDate = new Date(dt.getTime());
  
  // JST 0:00〜8:59 の場合、前日の日付として扱う
  if(jstHours < 9) {
    jstDate.setUTCDate(jstDate.getUTCDate() - 1);
  }

  // YYYY-MM-DD 形式で取得（UTCベースで取得）
  return jstDate.toISOString().slice(0, 10);
}

/**
 * 9時基準で2つの時刻が同じ日かを判定
 * @param {Date} d1 - 基準時刻
 * @param {Date} d2 - 比較時刻
 * @returns {boolean} 同じ日なら true
 */
function isSameJstDay(d1, d2) {
    // 9時基準で日付をリセットした時刻を比較
    const getBaseDate = (date) => {
        const temp = new Date(date);
        // JST 9:00 を基準にするために、一旦UTC時刻を9時間ずらす
        temp.setUTCHours(temp.getUTCHours() - 9);
        // 時刻情報をリセットし、日付部分だけを文字列化して比較
        return temp.toISOString().slice(0, 10);
    };
    return getBaseDate(d1) === getBaseDate(d2);
}


// --- イベント追加 ---
function addEvent(el, name, timeStr){
  if(clearedStages.includes(name)) return; // ステージ単位で非表示
  
  const li = document.createElement("li");
  li.className = "event-item upcoming";
  
  const d = getJstTime(timeStr); 
  
  // 時刻をJSTで表示するために UTC の時間を使用
  const timeText = d.getUTCHours().toString().padStart(2,'0') + ":" + d.getUTCMinutes().toString().padStart(2,'0');
  
  li.innerHTML = `<span class="event-time">${timeText}</span>${name} <input type="checkbox" class="check">`;

  const checkbox = li.querySelector(".check");
  // チェックボックスの初期状態を設定（クリア済みはチェック状態のまま）
  checkbox.checked = clearedStages.includes(name); 

  // チェックは即反映せず、反映ボタンで URL 更新 (変更なし)
  checkbox.addEventListener("change", ()=>{});

  el.appendChild(li);
}

// --- レンダリング ---
function render(){
  todayEl.innerHTML=""; 
  tomorrowEl.innerHTML=""; 
  futureEl.innerHTML="";

  const now = new Date(); // 現在時刻 (ローカルタイムゾーン)
  
  // 9時基準で日付を判定
  const JST_OFFSET_MS = 9 * 60 * 60 * 1000;
  
  // 今日の9時（JST）を基準点とする
  const todayStart = new Date(now.getTime() + JST_OFFSET_MS); // UTC時刻をJSTに変換
  todayStart.setUTCHours(9, 0, 0, 0); // JST 9:00 に設定
  todayStart.setTime(todayStart.getTime() - JST_OFFSET_MS); // ローカルタイムに戻す（UTC 0:00 に相当）

  // 現在の9時基準の「今日」のDateオブジェクト（比較用）
  const nowJst = new Date(now.getTime() + JST_OFFSET_MS); // JST
  
  // 9時基準の「明日」のDateオブジェクト（比較用）
  const tomorrowJst = new Date(nowJst);
  tomorrowJst.setUTCDate(nowJst.getUTCDate() + 1);

  // 日付ごとにまとめる
  let dateMap = {}; // Key: YYYY-MM-DD
  events.forEach(ev => {
    ev.times.forEach(t => {
      const d = getJstTime(t); // イベント時刻（JST）
      const dateStr = getJstDate(t); // 9時基準の日付文字列
      
      if(!dateMap[dateStr]) dateMap[dateStr] = [];
      dateMap[dateStr].push({name: ev.name, time: t, date: d});
    });
  });

  // 分類と表示
  Object.keys(dateMap).sort().forEach(dateStr => {
      const eventList = dateMap[dateStr];
      const firstEventDate = eventList[0].date; // 分類用のDateオブジェクト

      let targetEl = futureEl;
      let titleText = dateStr;

      if(isSameJstDay(firstEventDate, nowJst)){
          // 今日
          targetEl = todayEl;
      } else if (isSameJstDay(firstEventDate, tomorrowJst)){
          // 明日
          targetEl = tomorrowEl;
      } 
      
      // 明後日以降は、日付ごとに ul を作成してfutureElに追加
      if (targetEl === futureEl) {
        const div = document.createElement("div");
        const title = document.createElement("h3");
        title.textContent = dateStr;
        div.appendChild(title);

        const ul = document.createElement("ul"); ul.className="event-list";
        
        eventList.sort((a,b)=>a.date - b.date)
                 .forEach(ev=>addEvent(ul, ev.name, ev.time));

        div.appendChild(ul);
        futureEl.appendChild(div);

      } else {
        // 今日・明日は ul に直接追加
        eventList.sort((a,b)=>a.date - b.date)
                 .forEach(ev=>addEvent(targetEl, ev.name, ev.time));
      }
  });

  renderClearedList();
}

// --- クリア済みリスト ---
function renderClearedList(){
  clearedEl.innerHTML="";
  if(clearedStages.length===0){ 
    clearedEl.textContent="なし"; 
    return;
  }
  // (以降、変更なし)
  const ul = document.createElement("ul"); ul.className="event-list";
  clearedStages.forEach(name=>{
    const li = document.createElement("li");
    li.innerHTML = `${name} <button class="remove">×</button>`;
    li.querySelector(".remove").addEventListener("click", ()=> {
      clearedStages = clearedStages.filter(x=>x!==name);
      render();
    });
    ul.appendChild(li);
  });
  clearedEl.appendChild(ul);
}

// --- ボタン ---
document.getElementById("update-url").addEventListener("click", ()=> {
  const newCleared = [];
  document.querySelectorAll(".check:checked").forEach(cb=>{
    // nameの取得方法を修正（チェックボックスから離れた親要素から名前を取得する必要があるため）
    const listItem = cb.closest('.event-item');
    if (listItem) {
        // イベント名を取得するために、時刻とチェックボックスのテキストを除外してトリム
        const timeText = listItem.querySelector('.event-time').textContent;
        let name = listItem.textContent.replace(timeText, '').replace(/×$/, '').trim();
        // チェックボックスの文字も消す
        name = name.substring(0, name.length - 1).trim(); 
        if(!newCleared.includes(name)) newCleared.push(name);
    }
  });

  // URLパラメータ更新のロジックを修正
  // 現在のclearedStagesと新しいnewClearedをマージし、重複を排除
  clearedStages = Array.from(new Set([...clearedStages, ...newCleared]));

  const params = new URLSearchParams();
  if(clearedStages.length>0) params.set("cleared", clearedStages.join(","));
  window.location.search=params.toString();
});

document.getElementById("copy-url").addEventListener("click", ()=> {
  navigator.clipboard.writeText(window.location.href).then(()=>alert("URLをコピーしました！"));
});

document.getElementById("show-cleared").addEventListener("click", ()=> {
  clearedEl.style.display = clearedEl.style.display==="none" ? "block" : "none";
});

render();
</script>
</body>
</html>
